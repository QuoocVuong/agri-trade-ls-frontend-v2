<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">Quản lý Đơn hàng</h1>

  <!-- Filter Form -->
  <form [formGroup]="filterForm" class="mb-6 p-4  rounded-box grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
    <div class="form-control w-full">
      <label class="label"><span class="label-text">Tìm kiếm (Mã ĐH, Tên...)</span></label>
      <input type="text" placeholder="Nhập từ khóa..." class="input input-sm input-bordered w-full" formControlName="keyword" />
    </div>
    <div class="form-control w-full">
      <label class="label"><span class="label-text">Trạng thái ĐH</span></label>
      <select class="select select-sm select-bordered w-full" formControlName="status">
        <option value="">Tất cả trạng thái</option>
        <option *ngFor="let status of orderStatuses" [value]="status">{{ getStatusText(status) }}</option>
      </select>
    </div>
    <div class="form-control w-full">
      <label class="label"><span class="label-text">ID Người mua</span></label>
      <input type="number" placeholder="Nhập ID người mua" class="input input-sm input-bordered w-full" formControlName="buyerId" />
    </div>
    <div class="form-control w-full">
      <label class="label"><span class="label-text">ID Nông dân</span></label>
      <input type="number" placeholder="Nhập ID nông dân" class="input input-sm input-bordered w-full" formControlName="farmerId" />
    </div>
  </form>

  <!-- Loading / Error / Empty -->
  <div *ngIf="isLoading() && !ordersPage()" class="text-center py-10"><app-loading-spinner></app-loading-spinner></div>
  <app-alert *ngIf="errorMessage()" type="error" [message]="errorMessage()"></app-alert>
  <div *ngIf="!isLoading() && (!ordersPage() || (ordersPage()?.content?.length ?? 0) === 0) && !errorMessage()" class="text-center py-10 text-base-content/60">
    Không tìm thấy đơn hàng nào phù hợp.
  </div>

  <!-- Orders Table -->
  <div *ngIf="!isLoading() && ordersPage() && ordersPage()!.content.length > 0" class="overflow-x-auto  rounded-box shadow">
    <table class="table table-zebra w-full table-sm">
      <thead>
      <tr>
        <th>Mã ĐH</th>
        <th>Ngày đặt</th>
        <th>Người mua</th>
        <th>Người bán</th>
        <th class="text-right">Tổng tiền</th>
        <th>Trạng thái ĐH</th>
        <th>Trạng thái TT</th>
        <th>Hành động</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let order of ordersPage()?.content; trackBy: trackOrderById" class="hover">
        <td class="font-mono text-xs">
          <a (click)="viewOrderDetails(order.id)" class="link link-hover link-primary">{{ order.orderCode }}</a>
          <span class="block text-xs opacity-70">{{ order.orderType }}</span>
        </td>
        <td class="text-xs">{{ order.createdAt | date:'dd/MM/yy HH:mm' }}</td>
        <td class="text-xs">{{ order.buyerName || 'N/A' }}</td>
        <td class="text-xs">{{ order.farmerName || 'N/A' }}</td>
        <td class="text-right text-xs font-semibold">{{ order.totalAmount | formatBigDecimal:'1.0-0' }} đ</td>
        <td><span class="badge badge-sm" [ngClass]="getStatusClass(order.status)">{{ getStatusText(order.status) }}</span></td>
        <td><span class="badge badge-sm" [ngClass]="getPaymentStatusClass(order.paymentStatus)">{{ getPaymentStatusText(order.paymentStatus) }}</span></td>
        <td>
          <div class="dropdown dropdown-left">
            <label tabindex="0" class="btn btn-ghost btn-xs">...</label>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-48 text-xs">
              <li><a (click)="viewOrderDetails(order.id)">Xem/Sửa chi tiết</a></li>
              <!-- <li><a (click)="updateStatus(order.id)">Cập nhật trạng thái</a></li> -->
              <!-- Thêm các action khác nếu cần -->
              <li *ngIf="order.status !== 'CANCELLED' && order.status !== 'DELIVERED' && order.status !== 'RETURNED'">
                <a class="text-error" (click)="cancelOrder(order)">Hủy đơn hàng</a>
              </li>
              <!-- Ví dụ nút xác nhận thanh toán CK -->
              <!-- <li *ngIf="order.paymentMethod === 'BANK_TRANSFER' && order.paymentStatus === 'PENDING'">
                  <a class="text-success">Xác nhận đã thanh toán</a>
              </li> -->
            </ul>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="ordersPage() && ordersPage()!.totalPages > 1" class="mt-6 flex justify-center">
    <app-paginator
      [currentPage]="ordersPage()!.number"
      [totalPages]="ordersPage()!.totalPages"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  </div>

  <!-- TODO: Thêm Modal để cập nhật trạng thái đơn hàng nếu cần giao diện phức tạp hơn -->

</div>
