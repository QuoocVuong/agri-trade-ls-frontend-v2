<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">Quản lý Hóa đơn Công nợ</h1>

  <!-- Filters -->
  <form [formGroup]="filterForm" class="mb-6 p-4 bg-base-200 dark:bg-gray-800 rounded-lg shadow">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
      <div>
        <label for="keyword" class="label"><span class="label-text">Tìm kiếm</span></label>
        <input type="text" id="keyword" formControlName="keyword" placeholder="Mã HĐ, Mã ĐH, Tên KH..." class="input input-sm input-bordered w-full">
      </div>
      <div>
        <label for="status" class="label"><span class="label-text">Trạng thái Hóa đơn</span></label>
        <select id="status" formControlName="status" class="select select-sm select-bordered w-full">
          <option value="">Tất cả trạng thái</option>
          <option *ngFor="let statusOpt of invoiceStatusOptions" [value]="statusOpt">
            {{ getInvoiceStatusText(statusOpt) }}
          </option>
        </select>
      </div>
      <div>
        <button type="button" class="btn btn-sm btn-ghost" (click)="clearFilters()">Xóa bộ lọc</button>
      </div>
    </div>
  </form>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="text-center py-20">
    <app-loading-spinner size="lg"></app-loading-spinner>
  </div>

  <!-- Error State -->
  <app-alert *ngIf="errorMessage() && !isLoading()" type="error" [message]="errorMessage()!"></app-alert>

  <!-- Invoice Table -->
  <div *ngIf="!isLoading() && invoicesPage()?.content?.length" class="overflow-x-auto bg-base-100 dark:bg-gray-800 rounded-lg shadow">
    <table class="table table-zebra table-sm w-full">
      <thead>
      <tr>
        <th>Mã HĐ</th>
        <th>Mã ĐH</th>
        <th>Khách hàng</th>
        <th class="text-right">Tổng tiền</th>
        <th>Ngày PH</th>
        <th>Ngày ĐH</th>
        <th>Trạng thái HĐ</th>
        <th>Hành động</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let inv of invoicesPage()?.content; trackBy: trackInvoiceById" class="hover">
        <td>
          <span class="font-semibold">{{ inv.invoiceNumber }}</span>
        </td>
        <td>
          <a [routerLink]="['/admin/orders', inv.orderId]" class="link link-hover text-primary" title="Xem chi tiết đơn hàng">
            {{ inv.orderCode }}
          </a>
        </td>
        <td>{{ inv.buyerFullName }}</td>
        <td class="text-right">{{ inv.totalAmount | number:'1.0-0' }} đ</td>
        <td>{{ inv.issueDate | date:'dd/MM/yy' }}</td>
        <td>
            <span [class.text-error]="inv.dueDate && inv.status === InvoiceStatusEnum.OVERDUE && isDueDatePast(inv.dueDate, today)">
             {{ inv.dueDate | date:'dd/MM/yy' }}
            </span>
        </td>
        <td>
            <span class="badge badge-sm" [ngClass]="getInvoiceStatusClass(inv.status)">
              {{ getInvoiceStatusText(inv.status) }}
            </span>
        </td>
        <td class="space-x-1">
          <button class="btn btn-xs btn-ghost text-info p-1" [routerLink]="['/admin/orders', inv.orderId]" title="Xem chi tiết đơn hàng">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-.274.996-.686 1.932-1.198 2.784M14 14l-2.168 2.168a2.502 2.502 0 01-3.536 0L5 13" /></svg>
          </button>
          <button *ngIf="inv.status === InvoiceStatusEnum.ISSUED || inv.status === InvoiceStatusEnum.OVERDUE"
                  class="btn btn-xs btn-ghost text-success p-1"
                  title="Xác nhận đã thanh toán"
                  (click)="confirmPayment(inv)"
                  [disabled]="isActionLoading() && actionInvoiceId() === inv.invoiceId">
            <span *ngIf="isActionLoading() && actionInvoiceId() === inv.invoiceId" class="loading loading-spinner loading-xs"></span>
            <svg *ngIf="!(isActionLoading() && actionInvoiceId() === inv.invoiceId)" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
          </button>
          <!-- Thêm các nút khác nếu cần (Gửi lại nhắc nhở, Hủy HĐ) -->
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading() && !invoicesPage()?.content?.length && !errorMessage()"
       class="text-center py-20 px-4 border border-dashed border-base-300 dark:border-gray-700 rounded-lg">
    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-base-content/20 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <p class="mt-4 text-xl font-medium text-base-content/70 dark:text-gray-400">Không tìm thấy hóa đơn nào khớp với tiêu chí.</p>
  </div>

  <!-- Pagination -->
  <div *ngIf="invoicesPage() && invoicesPage()!.totalPages > 1" class="mt-8 flex justify-center">
    <app-paginator
      [currentPage]="invoicesPage()!.number"
      [totalPages]="invoicesPage()!.totalPages"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  </div>

</div>
