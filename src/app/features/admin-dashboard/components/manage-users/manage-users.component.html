<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">Quản lý Người dùng</h1>

  <!-- Filter Form -->
  <form [formGroup]="filterForm" class="mb-6 p-4 rounded-box grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
    <div class="form-control w-full">
      <label class="label"><span class="label-text">Tìm kiếm (Tên, Email, SĐT)</span></label>
      <input type="text" placeholder="Nhập từ khóa..." class="input input-sm input-bordered w-full" formControlName="keyword" />
    </div>
    <div class="form-control w-full">
      <label class="label"><span class="label-text">Lọc theo vai trò</span></label>
      <select class="select select-sm select-bordered w-full" formControlName="role">
        <option value="">Tất cả vai trò</option>
        <option *ngFor="let role of roleTypes" [value]="role">{{ getRoleText(role) }}</option>
      </select>
    </div>
    <!-- ****** THÊM BỘ LỌC TRẠNG THÁI ISACTIVE ****** -->
    <div class="form-control w-full">
      <label class="label"><span class="label-text">Trạng thái tài khoản</span></label>
      <select class="select select-sm select-bordered w-full" formControlName="isActive">
        <option value="">Tất cả trạng thái</option>
        <option value="true">Active (Đang hoạt động)</option>
        <option value="false">Inactive (Vô hiệu hóa)</option>
      </select>
    </div>
    <div class="form-control w-full md:col-start-4"> <!-- Đẩy nút reset sang cột cuối nếu layout 4 cột -->
      <button type="button" class="btn btn-sm btn-ghost mt-4 md:mt-0 w-full md:w-auto" (click)="filterForm.reset({ keyword: '', role: '', isActive: '' })">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
        Xóa bộ lọc
      </button>
    </div>
  </form>

  <!-- Loading / Error / Empty -->
  <div *ngIf="isLoading() && !usersPage()" class="text-center py-10"><app-loading-spinner></app-loading-spinner></div>
  <app-alert *ngIf="errorMessage()" type="error" [message]="errorMessage()"></app-alert>
  <div *ngIf="!isLoading() && (!usersPage() || (usersPage()?.content?.length ?? 0) === 0) && !errorMessage()" class="text-center py-10 text-base-content/60">
    Không tìm thấy người dùng nào phù hợp.
  </div>

  <!-- Users Table -->
  <div *ngIf="!isLoading() && usersPage() && usersPage()!.content.length > 0" class="overflow-x-auto  rounded-box shadow">
    <table class="table table-zebra w-full table-sm">
      <thead>
      <tr>
        <th>ID</th>
        <th>Người dùng</th>
        <th>Email</th>
        <th>SĐT</th>
        <th>Vai trò</th>
        <th>Trạng thái</th>
        <th>Ngày tạo</th>
        <th>Hành động</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let user of usersPage()?.content; trackBy: trackUserById" class="hover">
        <td class="font-mono text-xs">{{ user.id }}</td>
        <td>
          <div class="flex items-center space-x-3">
            <div class="avatar">
              <div class="mask mask-squircle w-8 h-8">
                <img [src]="user.avatarUrl || 'assets/images/default-avatar.png'" [alt]="user.fullName" />
              </div>
            </div>
            <div>
              <div class="font-bold text-sm">{{ user.fullName }}</div>
            </div>
          </div>
        </td>
        <td class="text-xs">{{ user.email }}</td>
        <td class="text-xs">{{ user.phoneNumber || '-' }}</td>
        <td>
          <div class="flex flex-wrap gap-1">
            <span *ngFor="let role of user.roles" class="badge badge-ghost badge-xs">{{ getRoleText(role) }}</span>
          </div>
        </td>
        <td>
            <span class="badge badge-sm" [ngClass]="user.active ? 'badge-success' : 'badge-error'">
              {{ user.active ? 'Active' : 'Inactive' }}
            </span>
        </td>
        <td class="text-xs">{{ user.createdAt | date:'dd/MM/yy HH:mm' }}</td>
        <td>
          <div class="dropdown dropdown-left"> <!-- Hoặc dropdown-end để nó mở sang phải -->
            <label tabindex="0" class="btn btn-ghost btn-xs">...</label>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-40 text-xs">
              <li><a (click)="viewUserDetails(user.id)">Xem chi tiết</a></li>
              <li><a (click)="openEditRolesModal(user)">Sửa vai trò</a></li>
              <!-- Điều kiện riêng cho Kích hoạt -->
              <li *ngIf="!user.active">
                <a (click)="toggleUserStatus(user)" class="text-success">
                  Kích hoạt
                </a>
              </li>
              <!-- Điều kiện riêng cho Vô hiệu hóa -->
              <li *ngIf="user.active">
                <a (click)="toggleUserStatus(user)" class="text-error">
                  Vô hiệu hóa
                </a>
              </li>
              <!-- <li><a class="text-error">Xóa vĩnh viễn</a></li> -->
            </ul>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="usersPage() && usersPage()!.totalPages > 1" class="mt-6 flex justify-center">
    <app-paginator
      [currentPage]="usersPage()!.number"
      [totalPages]="usersPage()!.totalPages"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  </div>

  <!-- Modal Xem Chi Tiết User -->
  <app-modal title="Chi tiết người dùng" [isOpen]="showDetailModal()" (closed)="closeDetailModal()" modalBoxClasses="w-11/12 max-w-2xl">
    <div *ngIf="selectedUser() as profile" class="text-sm space-y-3">
      <p><strong>ID:</strong> {{ profile.id }}</p>
      <p><strong>Họ tên:</strong> {{ profile.fullName }}</p>
      <p><strong>Email:</strong> {{ profile.email }}</p>
      <p><strong>SĐT:</strong> {{ profile.phoneNumber || 'N/A' }}</p>
      <p><strong>Ngày tạo:</strong> {{ profile.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
      <p><strong>Vai trò:</strong> {{ profile.roles?.join(', ') }}</p>
      <!-- Hiển thị thêm thông tin Farmer/Business Profile nếu có -->
      <div *ngIf="profile.farmerProfile as fp" class="mt-4 pt-4 border-t">
        <h4 class="font-semibold">Hồ sơ Nông dân:</h4>
        <p>Tên trang trại: {{ fp.farmName }}</p>
        <p>Địa chỉ: {{ fp.addressDetail }}, {{ fp.wardCode }}, {{ fp.districtCode }}, {{ fp.provinceCode }}</p>
        <p>Trạng thái: {{ fp.verificationStatus }}</p>
      </div>
      <div *ngIf="profile.businessProfile as bp" class="mt-4 pt-4 border-t">
        <h4 class="font-semibold">Hồ sơ Doanh nghiệp:</h4>
        <p>Tên DN: {{ bp.businessName }}</p>
        <p>MST: {{ bp.taxCode || 'N/A' }}</p>
        <p>Địa chỉ: {{ bp.businessAddressDetail }}, {{ bp.wardCode }}, {{ bp.districtCode }}, {{ bp.businessProvinceCode }}</p>
      </div>
    </div>
    <div modal-actions> <!-- Nút trong modal -->
      <button class="btn btn-sm" (click)="closeDetailModal()">Đóng</button>
    </div>
  </app-modal>

  <!-- Modal Sửa Roles -->
  <app-modal title="Cập nhật vai trò" [isOpen]="showRoleModal()" (closed)="closeRoleModal()" [showActions]="true" [hideDefaultCancel]="true">
    <div *ngIf="selectedUserIdForRoles()" class="space-y-2">
      <p class="text-sm mb-3">Chọn vai trò cho người dùng ID: <strong>{{ selectedUserIdForRoles() }}</strong></p>
      <div *ngFor="let role of availableRoles()" class="form-control">
        <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" class="checkbox checkbox-primary checkbox-sm"
                 [value]="role"
                 [checked]="currentUserRoles().has(role)"
                 (change)="onRoleChange($event, role)" />
          <span class="label-text">{{ getRoleText(role) }}</span>
        </label>
      </div>
    </div>
    <div modal-actions>
      <button class="btn btn-sm btn-ghost" (click)="closeRoleModal()">Hủy</button>
      <button class="btn btn-sm btn-primary" (click)="saveRoles()" [disabled]="isLoading()">
        <span *ngIf="isLoading()" class="loading loading-spinner loading-xs"></span>
        Lưu vai trò
      </button>
    </div>
  </app-modal>

</div>
