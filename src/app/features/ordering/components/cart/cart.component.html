<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">Giỏ hàng của bạn</h1>

  <!-- Loading -->
  <div *ngIf="isLoading()" class="text-center py-10"><app-loading-spinner></app-loading-spinner></div>
  <!-- Error -->
  <app-alert *ngIf="errorMessage()" type="error" [message]="errorMessage()"></app-alert>

  <!-- Cart Content -->
  <ng-container *ngIf="cart() as cartData; else emptyCart"> <!-- Dùng signal cart() -->
    <div *ngIf="cartData.items && cartData.items.length > 0; else emptyCart" class="flex flex-col lg:flex-row gap-8">

      <!-- Cart Items List -->
      <div class="lg:w-2/3">
        <div class="space-y-4">
          <div *ngFor="let item of cartData.items; trackBy: trackCartItemById" class="card card-side shadow-sm flex-col sm:flex-row relative">
            <figure class="p-2 sm:w-24 flex-shrink-0">
              <img [src]="item.product?.thumbnailUrl || 'assets/images/placeholder-image.png'"
                   [alt]="item.product?.name"
                   class="w-full h-24 sm:h-full object-cover rounded-md">
            </figure>
            <div class="card-body p-3 sm:p-4 flex-grow">
              <div class="flex justify-between items-start gap-2">
                <div>
                  <a [routerLink]="['/products', item.product?.slug]" class="link link-hover font-semibold line-clamp-2 mb-1">
                    {{ item.product?.name || 'Sản phẩm không xác định' }}
                  </a>
                  <div class="text-xs text-base-content/70">
                    Cung cấp bởi:
                    <a [routerLink]="['/farmer', item.product?.farmerInfo?.farmerId]" class="link link-hover">
                      {{ item.product?.farmerInfo?.farmName || 'N/A' }}
                    </a>
                  </div>
                  <!-- Hiển thị giá/đơn vị đúng -->
                  <div class="text-sm font-medium mt-1">
                    {{ getDisplayInfo(item).price | formatBigDecimal:'1.0-0' }} đ / {{ getDisplayInfo(item).unit }}
                    <!-- Thêm nhãn B2B nếu cần -->
                    <span *ngIf="isBusinessBuyer() && item.product?.b2bEnabled" class="badge badge-xs badge-info  ml-1">B2B</span>
                  </div>
                </div>
                <!-- Remove Button -->
                <button class="btn btn-ghost btn-xs text-error" (click)="removeItem(item.id)" [disabled]="isItemLoading(item.id)">
                  <span *ngIf="isItemLoading(item.id)" class="loading loading-spinner loading-xs"></span>
                  <svg *ngIf="!isItemLoading(item.id)" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
              </div>
              <!-- Quantity Selector -->
              <div class="card-actions justify-start items-center mt-2">
                <span class="text-sm mr-2">Số lượng:</span>
                <div class="join">
                  <button class="btn btn-xs join-item"
                          (click)="updateQuantity(item, item.quantity - 1)"
                          [disabled]="item.quantity <= ((isBusinessBuyer() && item.product?.b2bEnabled) ? (item.product?.minB2bQuantity || 1) : 1) || isItemLoading(item.id)">-</button>
                  <input type="number" class="input input-xs input-bordered w-12 text-center join-item"
                         [value]="item.quantity"
                         [min]="(isBusinessBuyer() && item.product?.b2bEnabled) ? (item.product?.minB2bQuantity || 1) : 1"
                         [max]="item.product?.stockQuantity"
                  #qtyInput
                  (change)="updateQuantity(item, qtyInput.valueAsNumber)"
                  [id]="'quantity-input-' + item.id"> <!-- Thêm ID để dễ truy cập từ TS -->
                  <button class="btn btn-xs join-item"
                          (click)="updateQuantity(item, item.quantity + 1)"
                          [disabled]="item.quantity >= (item.product?.stockQuantity ?? 0) || isItemLoading(item.id)">+</button> <!-- ****** THÊM KIỂM TRA STOCK ****** -->
                </div>
                <!-- (Tùy chọn) Hiển thị số lượng tồn kho -->
                <span class="text-xs text-base-content/60 ml-2">(Còn: {{ item.product?.stockQuantity ?? 0 }})</span>
              </div>
              <!-- Item Total -->
              <p class="text-right font-semibold mt-2 text-sm">Thành tiền: {{ calculateItemTotal(item) | formatBigDecimal:'1.0-0' }} đ</p>
            </div>
          </div>
        </div>
        <!-- Clear Cart Button -->
        <div class="mt-6 text-right">
          <button class="btn btn-outline btn-error btn-sm" (click)="clearCart()" [disabled]="clearLoading()">
            <span *ngIf="clearLoading()" class="loading loading-spinner loading-xs"></span>
            Xóa hết giỏ hàng
          </button>
        </div>
      </div>

      <!-- Cart Summary & Checkout -->
      <div class="lg:w-1/3">
        <div class="card shadow-md sticky top-20"> <!-- sticky top để giữ khi scroll -->
          <div class="card-body">
            <h2 class="card-title text-lg mb-4">Tóm tắt đơn hàng</h2>
            <div class="flex justify-between text-sm mb-2">
              <span>Tổng số sản phẩm:</span>
              <span>{{ cartData.totalItems }}</span>
            </div>
            <div class="flex justify-between text-sm mb-4">
              <span>Tạm tính:</span>
              <!-- File: cart.component.html -->
              <span class="font-semibold">{{ calculatedSubTotal() | formatBigDecimal:'1.0-0' }} đ</span>
            </div>
            <div class="divider my-0"></div>
            <p class="text-xs text-base-content/60 mt-2">Phí vận chuyển và giảm giá (nếu có) sẽ được tính ở bước thanh toán.</p>
            <!-- Thêm ghi chú B2B -->
            <p *ngIf="isBusinessBuyer()" class="text-xs text-info mt-1">Giá B2B đã được áp dụng (nếu có).</p>
            <div class="card-actions mt-4">
              <button class="btn btn-primary w-full" (click)="goToCheckout()">Tiến hành Thanh toán</button>
            </div>
            <div class="mt-4 text-center">
              <a routerLink="/products" class="link link-hover text-sm">← Tiếp tục mua hàng</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </ng-container>

  <!-- Empty Cart Template -->
  <ng-template #emptyCart>
    <div *ngIf="!isLoading()" class="text-center py-20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/30 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <p class="text-lg text-base-content/60 mb-6">Giỏ hàng của bạn đang trống.</p>
      <a routerLink="/products" class="btn btn-primary">Bắt đầu mua sắm</a>
    </div>
  </ng-template>

</div>
