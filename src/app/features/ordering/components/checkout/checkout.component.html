<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6 text-center">Hoàn tất Đơn hàng</h1>

  <div *ngIf="cart() && cart()!.items.length > 0; else emptyCartRedirect" class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Cột trái: Form thông tin -->
    <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="lg:col-span-2 space-y-6">

      <!-- Bước 1: Địa chỉ giao hàng -->
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <div class="flex justify-between items-center mb-3">
            <h2 class="card-title text-lg">1. Địa chỉ giao hàng</h2>
            <button type="button" class="btn btn-xs btn-outline btn-secondary" (click)="toggleNewAddressForm()" [disabled]="isLoadingAddresses()">
              {{ showNewAddressForm() ? 'Chọn địa chỉ đã lưu' : 'Thêm địa chỉ mới' }}
            </button>
          </div>

          <!-- Loading Addresses -->
          <div *ngIf="isLoadingAddresses()" class="text-center py-5"><app-loading-spinner size="sm"></app-loading-spinner></div>

          <!-- Form thêm địa chỉ mới -->
          <div *ngIf="showNewAddressForm()">
            <h4 class="text-sm font-semibold mb-2">Thêm địa chỉ giao hàng mới:</h4>
            <app-address-form (addressSaved)="handleNewAddressSaved($event)" (cancelled)="toggleNewAddressForm()"></app-address-form>
            <p class="text-xs text-warning mt-2">Vui lòng lưu địa chỉ mới hoặc hủy để tiếp tục.</p>
          </div>

          <!-- Select địa chỉ đã lưu -->
          <div *ngIf="!showNewAddressForm() && !isLoadingAddresses()">
            <div *ngIf="addresses().length > 0; else noAddress" class="form-control">
              <label class="label"><span class="label-text text-sm">Chọn địa chỉ đã lưu:</span></label>
              <select class="select select-bordered w-full" formControlName="shippingAddressId"
                      [ngClass]="{'select-error': checkoutForm.controls['shippingAddressId'].invalid && checkoutForm.controls['shippingAddressId'].touched}">
                <option *ngFor="let addr of addresses()" [value]="addr.id">
                  {{addr.fullName}} - {{addr.phoneNumber}} - {{addr.addressDetail}}, {{addr.wardCode}}, {{addr.districtCode}}, {{addr.provinceCode}} {{addr.isDefault ? '(Mặc định)' : ''}}
                </option>
              </select>
              <label class="label py-0 h-4" *ngIf="checkoutForm.controls['shippingAddressId'].invalid && checkoutForm.controls['shippingAddressId'].touched">
                <span class="label-text-alt text-error text-xs">Vui lòng chọn địa chỉ.</span>
              </label>
            </div>
            <ng-template #noAddress>
              <p class="text-sm text-warning">Bạn chưa có địa chỉ nào. Vui lòng thêm địa chỉ mới.</p>
              <button type="button" class="btn btn-xs btn-secondary mt-2" (click)="toggleNewAddressForm()">Thêm địa chỉ mới</button>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Bước 2: Phương thức thanh toán -->
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-3">2. Phương thức thanh toán</h2>
          <div class="form-control space-y-2">
            <label *ngFor="let method of paymentMethods" class="label cursor-pointer border border-base-300 rounded-lg p-3 hover:bg-base-200 transition-colors">
              <span class="label-text font-medium">{{ getPaymentMethodText(method) }}</span>
              <input type="radio" name="paymentMethod" class="radio radio-primary" [value]="method" formControlName="paymentMethod"/>
            </label>
            <label class="label py-0 h-4" *ngIf="checkoutForm.controls['paymentMethod'].invalid && checkoutForm.controls['paymentMethod'].touched">
              <span class="label-text-alt text-error text-xs">Vui lòng chọn phương thức thanh toán.</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Bước 3: Ghi chú -->
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-3">3. Ghi chú cho đơn hàng (Tùy chọn)</h2>
          <textarea class="textarea textarea-bordered h-24" placeholder="Ví dụ: Giao hàng giờ hành chính, gọi trước khi giao..." formControlName="notes"></textarea>
        </div>
      </div>

      <!-- Thông báo lỗi chung -->
      <app-alert *ngIf="errorMessage()" type="error" [message]="errorMessage()"></app-alert>

      <!-- Nút Đặt hàng -->
      <div class="mt-6">
        <button type="submit" class="btn btn-primary w-full" [disabled]="isLoadingCheckout() || (checkoutForm.invalid && !showNewAddressForm())">
          <span *ngIf="isLoadingCheckout()" class="loading loading-spinner loading-xs"></span>
          {{ isLoadingCheckout() ? 'Đang xử lý...' : 'Đặt hàng' }}
        </button>
      </div>

    </form>

    <!-- Cột phải: Tóm tắt đơn hàng -->
    <div class="lg:col-span-1">
      <div class="card bg-base-200 shadow-md sticky top-20">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">Tóm tắt đơn hàng</h2>
          <div class="space-y-2 max-h-60 overflow-y-auto pr-2 mb-4">
            <div *ngFor="let item of cart()?.items" class="flex justify-between items-center text-sm border-b border-base-300 pb-2 last:border-b-0">
              <div class="flex items-center gap-2 overflow-hidden">
                <img [src]="item.product?.thumbnailUrl || 'assets/images/placeholder-image.png'" alt="" class="w-8 h-8 object-cover rounded flex-shrink-0">
                <div class="flex-grow">
                  <p class="line-clamp-1 text-xs font-medium">{{ item.product?.name }}</p>
                  <p class="text-xs text-base-content/60">SL: {{ item.quantity }}</p>
                </div>
              </div>
              <span class="font-medium text-xs flex-shrink-0 ml-2">{{ item.itemTotal | formatBigDecimal:'1.0-0' }} đ</span>
            </div>
          </div>
          <div class="space-y-1 text-sm border-t border-base-300 pt-4">
            <div class="flex justify-between"><span>Tạm tính</span> <span>{{ cart()?.subTotal | formatBigDecimal:'1.0-0' }} đ</span></div>
            <div class="flex justify-between"><span>Phí vận chuyển <button class="btn btn-xs btn-ghost p-0 h-auto min-h-0">(Tạm tính)</button></span> <span>{{ shippingFee() | number:'1.0-0' }} đ</span></div>
            <div class="flex justify-between"><span>Giảm giá</span> <span>- {{ discount() | number:'1.0-0' }} đ</span></div>
            <div class="divider my-1"></div>
            <div class="flex justify-between font-bold text-base">
              <span>Tổng cộng</span>
              <span class="text-primary">{{ totalAmount() | number:'1.0-0' }} đ</span>
            </div>
          </div>
          <p class="text-xs text-center mt-4 text-base-content/60">Nhấn "Đặt hàng" đồng nghĩa với việc bạn đồng ý với <a href="#" class="link">Điều khoản dịch vụ</a> của chúng tôi.</p>
        </div>
      </div>
    </div>

  </div>

  <ng-template #emptyCartRedirect>
    <div class="text-center py-20">
      <p class="text-lg text-base-content/60 mb-6">Giỏ hàng của bạn đang trống.</p>
      <a routerLink="/products" class="btn btn-primary">Tiếp tục mua sắm</a>
    </div>
  </ng-template>
</div>
