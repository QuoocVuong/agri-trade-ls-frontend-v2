<div class="container mx-auto px-4 py-6 md:py-8 lg:py-10 max-w-6xl">
  <!-- Header -->
  <h1 class="text-2xl md:text-3xl font-bold mb-6 text-center">Hoàn tất Đơn hàng</h1>

  <div *ngIf="cart() && cart()!.items.length > 0; else emptyCartRedirect" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Cột trái: Form thông tin -->
    <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="lg:col-span-2 space-y-6">
      <!-- Bước 1: Địa chỉ giao hàng -->
      <div class="card  shadow-md rounded-lg">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-lg">1. Địa chỉ giao hàng</h2>
            <button
              type="button"
              class="btn btn-sm btn-outline btn-secondary"
              (click)="toggleNewAddressForm()"
              [disabled]="isLoadingAddresses()">
              {{ showNewAddressForm() ? 'Chọn địa chỉ đã lưu' : 'Thêm địa chỉ mới' }}
            </button>
          </div>

          <!-- Loading Addresses -->
          <div *ngIf="isLoadingAddresses()" class="flex justify-center py-5">
            <app-loading-spinner size="sm"></app-loading-spinner>
          </div>

          <!-- Form thêm địa chỉ mới -->
          <div *ngIf="showNewAddressForm()" class="space-y-4">
            <h4 class="text-sm font-semibold">Thêm địa chỉ giao hàng mới:</h4>
            <app-address-form
              (addressSaved)="handleNewAddressSaved($event)"
              (cancelled)="toggleNewAddressForm()"></app-address-form>
            <p class="text-xs text-warning">Vui lòng lưu địa chỉ mới hoặc hủy để tiếp tục.</p>
          </div>

          <!-- Select địa chỉ đã lưu -->
          <div *ngIf="!showNewAddressForm() && !isLoadingAddresses()">
            <div *ngIf="addresses().length > 0; else noAddress" class="form-control">
              <label class="label">
                <span class="label-text font-medium text-sm">Chọn địa chỉ đã lưu:</span>
              </label>
              <select
                class="select select-bordered w-full"
                formControlName="shippingAddressId"
                [ngClass]="{'select-error': checkoutForm.controls['shippingAddressId'].invalid && checkoutForm.controls['shippingAddressId'].touched}">
                <!-- ****** SỬA NỘI DUNG OPTION Ở ĐÂY ****** -->
                <option *ngFor="let addr of addresses()" [value]="addr.id">
                  {{ addr.fullName }} - {{ addr.phoneNumber }} - {{ addr.addressDetail }}<span *ngIf="addr.addressDetail">, </span>
                  <!-- Sử dụng async pipe để hiển thị tên địa danh -->
                  <ng-container *ngIf="getLocationName('ward', addr.wardCode) | async as name; else wardCodeOnly">{{ name || '...' }}<span *ngIf="name">, </span></ng-container><ng-template #wardCodeOnly><span *ngIf="addr.wardCode">{{addr.wardCode}}, </span></ng-template>
                  <ng-container *ngIf="getLocationName('district', addr.districtCode) | async as name; else districtCodeOnly">{{ name || '...' }}<span *ngIf="name">, </span></ng-container><ng-template #districtCodeOnly><span *ngIf="addr.districtCode">{{addr.districtCode}}, </span></ng-template>
                  <ng-container *ngIf="getLocationName('province', addr.provinceCode) | async as name; else provinceCodeOnly">{{ name || '...' }}</ng-container><ng-template #provinceCodeOnly><span *ngIf="addr.provinceCode">{{addr.provinceCode}}</span></ng-template>
                  {{ addr.isDefault ? ' (Mặc định)' : '' }}
                </option>
                <!-- ***************************************** -->
              </select>
              <label *ngIf="checkoutForm.controls['shippingAddressId'].invalid && checkoutForm.controls['shippingAddressId'].touched" class="label py-1">
                <span class="label-text-alt text-error text-xs">Vui lòng chọn địa chỉ.</span>
              </label>
            </div>
            <ng-template #noAddress>
              <p class="text-sm text-warning">Bạn chưa có địa chỉ nào. Vui lòng thêm địa chỉ mới.</p>
              <button
                type="button"
                class="btn btn-sm btn-secondary mt-2"
                (click)="toggleNewAddressForm()">
                Thêm địa chỉ mới
              </button>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Bước 2: Phương thức thanh toán -->
      <div class="card  shadow-md rounded-lg">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">2. Phương thức thanh toán</h2>
          <div class="form-control space-y-2">
            <label
              *ngFor="let method of availablePaymentMethods()"
              class="label cursor-pointer border border-base-300 rounded-lg p-3 hover:bg-base-200 transition-colors flex justify-between items-center">
              <span class="label-text font-medium">{{ getPaymentMethodText(method) }}</span>
              <input
                type="radio"
                name="paymentMethod"
                class="radio radio-primary"
                [value]="method"
                formControlName="paymentMethod" />
            </label>
            <label *ngIf="checkoutForm.controls['paymentMethod'].invalid && checkoutForm.controls['paymentMethod'].touched" class="label py-1">
              <span class="label-text-alt text-error text-xs">Vui lòng chọn phương thức thanh toán.</span>
            </label>
          </div>
        </div>
      </div>

      <!-- *** THÊM INPUT PO NUMBER (CHỈ CHO B2B) *** -->
      <div *ngIf="isBusinessBuyer()" class="card  shadow">
        <div class="card-body">
          <h2 class="card-title text-lg mb-3">Thông tin Đơn đặt hàng (PO) - Tùy chọn</h2>
          <div class="form-control w-full">
            <label class="label"><span class="label-text">Số PO Number:</span></label>
            <input type="text" placeholder="Nhập số PO nếu có" class="input input-bordered w-full" formControlName="purchaseOrderNumber" />
          </div>
        </div>
      </div>
      <!-- ****************************************** -->

      <!-- Bước 3: Ghi chú -->
      <div class="card  shadow-md rounded-lg">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">3. Ghi chú cho đơn hàng (Tùy chọn)</h2>
          <textarea
            class="textarea textarea-bordered h-24"
            placeholder="Ví dụ: Giao hàng giờ hành chính, gọi trước khi giao..."
            formControlName="notes"></textarea>
        </div>
      </div>

      <!-- Thông báo lỗi chung -->
      <app-alert *ngIf="errorMessage()" type="error" [message]="errorMessage()" class="mt-4"></app-alert>

      <!-- Nút Đặt hàng -->
      <div class="mt-6">
        <button
          type="submit"
          class="btn btn-primary w-full"
          [disabled]="isLoadingCheckout() || (checkoutForm.invalid && !showNewAddressForm())">
          <span *ngIf="isLoadingCheckout()" class="loading loading-spinner loading-xs"></span>
          {{ isLoadingCheckout() ? 'Đang xử lý...' : 'Đặt hàng' }}
        </button>
      </div>
    </form>

    <!-- Cột phải: Tóm tắt đơn hàng -->
    <div class="lg:col-span-1">
      <div class="card shadow-md rounded-lg sticky top-20">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">Tóm tắt đơn hàng</h2>
          <!-- Danh sách sản phẩm -->
          <div class="space-y-3 max-h-60 overflow-y-auto pr-2 mb-4">
            <div *ngFor="let item of cart()?.items" class="flex items-center gap-3 border-b border-base-300 pb-3 last:border-b-0">
              <img
                [src]="item.product?.thumbnailUrl || 'assets/images/placeholder-image.png'"
                [alt]="item.product?.name"
                class="w-10 h-10 object-cover rounded flex-shrink-0" />
              <div class="flex-grow">
                <p class="text-sm font-medium line-clamp-1">{{ item.product?.name }}</p>
                <p class="text-xs text-base-content/60">SL: {{ item.quantity }}</p>
                <!-- (Tùy chọn) Hiển thị đơn giá đã tính -->
                <p class="text-xs text-base-content/60">
                  Đơn giá: {{ getDisplayInfo(item).price | formatBigDecimal:'1.0-0' }} đ / {{ getDisplayInfo(item).unit }}
                  <!-- Chỉ hiển thị text màu xanh -->
                  <span *ngIf="isBusinessBuyer() && item.product?.b2bEnabled" class="badge badge-xs badge-info  ml-1">B2B</span>
                </p>
              </div>
              <span class="text-sm font-medium flex-shrink-0">{{ calculateItemTotal(item)  | formatBigDecimal:'1.0-0' }} đ</span>
            </div>
          </div>
          <div class="space-y-2 text-sm border-t border-base-300 pt-4">
            <!-- Loading -->
            <div *ngIf="isLoadingTotals()" class="text-center text-xs py-1">
              <span class="loading loading-dots loading-xs"></span> Đang tính toán...
            </div>
            <ng-container *ngIf="!isLoadingTotals()">
              <div class="flex justify-between">
                <span>Tạm tính</span>
                <span class="font-medium">{{ calculatedSubTotal() | formatBigDecimal:'1.0-0' }} đ</span>
              </div>
              <div class="flex justify-between">
                <span>Phí vận chuyển</span>
                <span class="font-medium">{{ calculatedShippingFee() | formatBigDecimal:'1.0-0' }} đ</span>
              </div>
              <div class="flex justify-between">
                <span>Giảm giá</span>
                <span class="font-medium text-success">- {{ calculatedDiscount() | formatBigDecimal:'1.0-0' }} đ</span>
              </div>
              <div class="divider my-1"></div>
              <div class="flex justify-between font-bold text-base">
                <span>Tổng cộng</span>
                <span class="text-primary">{{ calculatedTotalAmount() | formatBigDecimal:'1.0-0' }} đ</span>
              </div>
            </ng-container>
          </div>
          <!-- ****** THÊM GHI CHÚ B2B/B2C ****** -->
          <div *ngIf="!isLoadingTotals() && orderTypeUsedInCalc()"> <!-- Chỉ hiện khi đã có kết quả tính toán -->
            <p *ngIf="isBusinessBuyer() && orderTypeUsedInCalc() === OrderType.B2B" class="text-xs text-info mt-2 text-center">
              Giá B2B và chiết khấu (nếu có) đã được áp dụng.
            </p>
            <!-- (Tùy chọn) Hiển thị cảnh báo nếu B2B user nhưng lại tính giá B2C -->
            <p *ngIf="isBusinessBuyer() && orderTypeUsedInCalc() === OrderType.B2C" class="text-xs text-warning mt-2 text-center">
              Lưu ý: Giá bán lẻ (B2C) đang được áp dụng cho đơn hàng này.
            </p>
            <!-- Có thể không cần hiển thị gì đặc biệt cho user B2C -->
          </div>
          <!-- ********************************** -->
          <p class="text-xs text-center mt-4 text-base-content/60">
            Nhấn "Đặt hàng" đồng nghĩa với việc bạn đồng ý với
            <a href="#" class="link link-hover hover:text-primary">Điều khoản dịch vụ</a> của chúng tôi.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty Cart Template -->
  <ng-template #emptyCartRedirect>
    <div class="text-center py-20">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-16 w-16 text-base-content/30 mx-auto mb-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="1">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <p class="text-lg text-base-content/60 mb-6">Giỏ hàng của bạn đang trống.</p>
      <a routerLink="/products" class="btn btn-primary">Tiếp tục mua sắm</a>
    </div>
  </ng-template>
</div>
