<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">Bảng điều khiển</h1>

  <!-- Loading / Error -->
  <div *ngIf="isLoadingStats() && isLoadingOrders() && isLoadingProducts()" class="text-center py-10"><app-loading-spinner size="lg"></app-loading-spinner></div>
  <app-alert *ngIf="errorMessage()" type="error" [message]="errorMessage()" class="mb-6"></app-alert>

  <!-- Stats Cards -->
  <div *ngIf="stats() as s" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
    <!-- Doanh thu Tháng -->
    <div class="stat bg-base-100 shadow rounded-box">
      <div class="stat-figure text-primary"><svg>...</svg></div> <!-- Icon tiền tệ -->
      <div class="stat-title text-sm">Doanh thu (Tháng)</div>
      <div class="stat-value text-primary">{{ (s.totalRevenueThisMonth ?? 0) | formatBigDecimal:'1.0-0' }} đ</div>
      <div class="stat-desc text-xs">Tính trên đơn đã giao/đang giao</div>
    </div>
    <!-- Đơn hàng Tháng -->
    <div class="stat bg-base-100 shadow rounded-box">
      <div class="stat-figure text-secondary"><svg>...</svg></div> <!-- Icon đơn hàng -->
      <div class="stat-title text-sm">Đơn hàng (Tháng)</div>
      <div class="stat-value text-secondary">{{ s.totalOrdersThisMonth ?? 0 }}</div>
      <div class="stat-desc text-xs">Tổng số đơn trong tháng</div>
    </div>
    <!-- Đơn hàng Chờ xử lý -->
    <div class="stat bg-base-100 shadow rounded-box">
      <div class="stat-figure text-info"><svg>...</svg></div> <!-- Icon xử lý -->
      <div class="stat-title text-sm">Đơn hàng chờ xử lý</div>
      <div class="stat-value text-info">{{ s.pendingOrders ?? 0 }}</div>
      <div class="stat-desc text-xs"><a routerLink="/farmer/orders" class="link link-hover link-info">Xem danh sách</a></div>
    </div>
    <!-- SP sắp hết hàng -->
    <div class="stat bg-base-100 shadow rounded-box">
      <div class="stat-figure text-warning"><svg>...</svg></div> <!-- Icon cảnh báo -->
      <div class="stat-title text-sm">Sản phẩm sắp hết</div>
      <div class="stat-value text-warning">{{ s.lowStockProducts ?? 0 }}</div>
      <div class="stat-desc text-xs"><a routerLink="/farmer/products" class="link link-hover link-warning">Kiểm tra kho hàng</a></div>
    </div>
    <!-- Có thể thêm thẻ cho Review chờ duyệt nếu cần -->
    <!-- <div class="stat bg-base-100 shadow rounded-box">... Pending Reviews ...</div> -->
  </div>

  <!-- Charts Section -->
  <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Revenue Chart -->
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <h3 class="card-title text-lg">Doanh thu 30 ngày qua</h3>
        <div *ngIf="isLoadingChart()" class="text-center py-10"><app-loading-spinner></app-loading-spinner></div>
        <div *ngIf="!isLoadingChart() && revenueChartData().length > 0" class="chart-container" style="height: 300px;"> <!-- Cần set chiều cao -->
          <ngx-charts-line-chart
            [view]="view"
          [scheme]="colorScheme"
          [results]="revenueChartData()"
          [gradient]="gradient"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="showLegend"
          [showXAxisLabel]="showXAxisLabel"
          [showYAxisLabel]="showYAxisLabel"
          [xAxisLabel]="xAxisLabel"
          [yAxisLabel]="yAxisLabelRevenue"
          [timeline]="timeline"
          [yAxisTickFormatting]="yAxisTickFormatting">
          </ngx-charts-line-chart>
        </div>
        <div *ngIf="!isLoadingChart() && revenueChartData().length === 0" class="text-center py-10 text-base-content/60">Không có dữ liệu doanh thu.</div>
      </div>
    </div>
    <!-- Order Count Chart -->
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <h3 class="card-title text-lg">Số đơn hàng 30 ngày qua</h3>
        <div *ngIf="isLoadingChart()" class="text-center py-10"><app-loading-spinner></app-loading-spinner></div>
        <div *ngIf="!isLoadingChart() && orderCountChartData().length > 0" class="chart-container" style="height: 300px;">
          <ngx-charts-line-chart
            [results]="orderCountChartData()"
            [scheme]="colorScheme"
            [gradient]="gradient"
            [xAxis]="showXAxis"
            [yAxis]="showYAxis"
            [legend]="showLegend"
            [showXAxisLabel]="showXAxisLabel"
            [showYAxisLabel]="showYAxisLabel"
            [xAxisLabel]="xAxisLabel"
            [yAxisLabel]="yAxisLabelCount"
            [timeline]="timeline">
          </ngx-charts-line-chart>
        </div>
        <div *ngIf="!isLoadingChart() && orderCountChartData().length === 0" class="text-center py-10 text-base-content/60">Không có dữ liệu đơn hàng.</div>
      </div>
    </div>
  </div>

  <!-- Recent Orders & Top Products -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Recent Orders -->
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title text-lg">Đơn hàng gần đây</h2>
          <a routerLink="/farmer/orders" class="btn btn-xs btn-ghost">Xem tất cả</a>
        </div>
        <div *ngIf="isLoadingOrders()" class="text-center py-5"><app-loading-spinner size="sm"></app-loading-spinner></div>
        <div *ngIf="!isLoadingOrders() && recentOrders().length === 0" class="text-center text-sm text-base-content/60 py-5">Không có đơn hàng gần đây.</div>
        <div *ngIf="!isLoadingOrders() && recentOrders().length > 0" class="space-y-2 max-h-80 overflow-y-auto"> <!-- Giới hạn chiều cao và scroll -->
          <div *ngFor="let order of recentOrders(); trackBy: trackOrderById" class="flex justify-between items-center text-xs border-b border-base-200 pb-2 last:border-b-0">
            <div>
              <a [routerLink]="['/farmer/orders', order.id]" class="link link-hover link-primary font-medium block">{{order.orderCode}}</a>
              <span class="text-base-content/70">{{order.buyerName || 'Khách hàng'}}</span>
            </div>
            <div class="text-right">
              <span class="font-semibold block">{{order.totalAmount | formatBigDecimal:'1.0-0'}} đ</span>
              <span class="badge badge-xs" [ngClass]="getStatusClass(order.status)">{{ getStatusText(order.status) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Selling Products -->
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title text-lg">Sản phẩm bán chạy</h2>
          <a routerLink="/farmer/products" class="btn btn-xs btn-ghost">Xem tất cả</a>
        </div>
        <div *ngIf="isLoadingProducts()" class="text-center py-5"><app-loading-spinner size="sm"></app-loading-spinner></div>
        <div *ngIf="!isLoadingProducts() && topProducts().length === 0" class="text-center text-sm text-base-content/60 py-5">Chưa có sản phẩm nào bán chạy.</div>
        <div *ngIf="!isLoadingProducts() && topProducts().length > 0" class="space-y-2 max-h-80 overflow-y-auto">
          <div *ngFor="let product of topProducts(); trackBy: trackProductById" class="flex items-center gap-3 border-b border-base-200 pb-2 last:border-b-0">
            <img [src]="product.thumbnailUrl || 'assets/images/placeholder-image.png'" [alt]="product.productName" class="w-10 h-10 object-cover rounded flex-shrink-0">
            <div class="flex-grow text-sm">
              <a [routerLink]="['/products', product.productSlug]" target="_blank" class="link link-hover line-clamp-1 font-medium">{{product.productName}}</a>
              <p class="text-xs text-base-content/70">Đã bán: {{product.totalQuantitySold}}</p>
            </div>
            <div class="text-sm font-semibold flex-shrink-0">{{product.totalRevenueGenerated | formatBigDecimal:'1.0-0'}} đ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
