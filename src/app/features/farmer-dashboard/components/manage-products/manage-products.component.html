<div class="container mx-auto px-4 py-8">
  <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-3xl font-bold">Quản lý Sản phẩm</h1>
    <a routerLink="/farmer/products/new" class="btn btn-primary btn-sm">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      Thêm sản phẩm mới
    </a>
  </div>

  <!-- Filter Form -->
  <form [formGroup]="filterForm" class="mb-6 p-4 bg-base-200 rounded-box flex flex-col md:flex-row gap-4 items-end">
    <div class="form-control w-full md:w-1/2">
      <label class="label"><span class="label-text">Tìm kiếm theo tên</span></label>
      <input type="text" placeholder="Nhập tên sản phẩm..." class="input input-sm input-bordered w-full" formControlName="keyword" />
    </div>
    <div class="form-control w-full md:w-1/4">
      <label class="label"><span class="label-text">Trạng thái</span></label>
      <select class="select select-sm select-bordered w-full" formControlName="status">
        <option value="">Tất cả</option>
        <option *ngFor="let status of productStatuses" [value]="status">{{ getStatusText(status) }}</option>
      </select>
    </div>
    <!-- Nút reset có thể thêm ở đây -->
  </form>

  <!-- Loading / Error / Empty -->
  <div *ngIf="isLoading() && !productsPage()" class="text-center py-10"><app-loading-spinner></app-loading-spinner></div>
  <app-alert *ngIf="errorMessage()" type="error" [message]="errorMessage()"></app-alert>
  <div *ngIf="!isLoading() && (!productsPage() || (productsPage()?.content?.length ?? 0) === 0) && !errorMessage()" class="text-center py-10 text-base-content/60">
    Bạn chưa có sản phẩm nào. Hãy <a routerLink="/farmer/products/new" class="link link-primary">thêm sản phẩm mới</a>.
  </div>

  <!-- Products Table -->
  <div *ngIf="!isLoading() && productsPage() && productsPage()!.content.length > 0" class="overflow-x-auto bg-base-100 rounded-box shadow">
    <table class="table w-full table-sm">
      <thead>
      <tr>
        <th>Sản phẩm</th>
        <th>Danh mục</th>
        <th class="text-right">Giá (B2C)</th>
        <th class="text-right">Tồn kho</th>
        <th>Trạng thái</th>
        <th>Ngày cập nhật</th>
        <th>Hành động</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let product of productsPage()?.content; trackBy: trackProductById" class="hover">
        <td>
          <div class="flex items-center space-x-3">
            <div class="avatar">
              <div class="mask mask-squircle w-10 h-10">
                <img [src]="product.thumbnailUrl || 'assets/images/placeholder-image.png'" [alt]="product.name" />
              </div>
            </div>
            <div>
              <div class="font-bold text-sm line-clamp-1">{{ product.name }}</div>
              <div class="text-xs opacity-70">{{ product.slug }}</div>
            </div>
          </div>
        </td>
        <td class="text-xs">{{ product.category?.name || 'N/A' }}</td> <!-- Cần có category name trong summary -->
        <td class="text-right text-xs font-medium">{{ product.price | formatBigDecimal:'1.0-0' }} đ</td>
        <td class="text-right text-xs" [class.text-error]="product.stockQuantity < 5" [class.font-bold]="product.stockQuantity < 5">
          {{ product.stockQuantity }}
        </td>
        <td>
            <span class="badge badge-sm" [ngClass]="getStatusClass(product.status)">
              {{ getStatusText(product.status) }}
            </span>
<!--          <p *ngIf="product.status === 'REJECTED'" class="text-xs text-error mt-1 italic" title="{{product.rejectReason}}">Bị từ chối</p> &lt;!&ndash; Hiển thị nếu bị từ chối &ndash;&gt;-->
<!--        </td>-->
        <td class="text-xs">{{ product.updatedAt | date:'dd/MM/yy HH:mm' }}</td>
        <td>
          <div class="flex gap-1">
            <a [routerLink]="['/farmer/products/edit', product.id]" class="btn btn-xs btn-ghost text-info" title="Sửa">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
            </a>
            <button class="btn btn-xs btn-ghost text-error" title="Xóa"
                    (click)="deleteProduct(product)" [disabled]="isDeleting(product.id)">
              <span *ngIf="isDeleting(product.id)" class="loading loading-spinner loading-xs"></span>
              <svg *ngIf="!isDeleting(product.id)" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
            </button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="productsPage() && productsPage()!.totalPages > 1" class="mt-6 flex justify-center">
    <app-paginator
      [currentPage]="productsPage()!.number"
      [totalPages]="productsPage()!.totalPages"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  </div>

</div>
